import requests
from bs4 import BeautifulSoup
from urllib.request import urlretrieve
import time
import random
import re

CVE_FILE = open("CVE_SOURCES.txt","r")

CVE_list = CVE_FILE.readlines()

CVE_FILE.close()
#print(CVE_list)

while(CVE_list.count("\n") > 0):
    CVE_list.remove("\n")
    pass

counter = 0
for line in CVE_list:
    CVE_list[counter] = line.replace("\n","")
    counter += 1
    pass

#print(CVE_list)

CVE_FILE = open("CVE_SOURCES_INFORMATION.txt","w")

counter = 0
for line in CVE_list:

    bot_counter = 0


    #True - only 10 bot Issues will be checked, past that it will be ignored
    #False - anything written by a BOT will be ignored
    if(True):
        if(bot_counter == 10):
            print("10 Bots reached, skipping further ones")
            continue
        if(line.find("[BOT]")!=-1):
            bot_counter = bot_counter + 1
    else:
        if(line.find("[BOT]")!=-1):
            continue


    if(counter == 0 ):
        CVE = line
        counter += 1
        print(CVE)
        CVE_FILE.write(line + "\n")
        continue
    if(line=="##############"):
        counter = 0
        CVE_FILE.write(line + "\n")
        continue
    if(counter==11): #we are restricting it to 10 results
        counter=11
        continue
    counter += 1
    try:
        #Serves the purpose of only searching Github and not other sources
        #we can look at other sources later
        if(line.find("github.com")==-1):
            continue

        #setting to skip any Bot written things

        CVE_FILE.write("MAINLINK="+line + "\n")
        if(line.find("[BOT]")!=-1):
            line = line.replace("[BOT]", "")
        print(line)
        #time.sleep(1)
        page = requests.get(line).content
        soup = BeautifulSoup(page, 'lxml')

        #Check for Codeboxes with Links
        try:
            Codeboxes = soup.body.find_all("div", {"class": lambda c: c and 'Box Box--condensed my-2' in c})
            for box in Codeboxes:
                detail = box.find("p", {"class": lambda c: c and 'mb-0 text-bold' in c}).find("a")
                CVE_FILE.write("CASE-1" + "\n")
                CVE_FILE.write(detail.get("href") + "\n")
                CVE_FILE.write(detail.get_text() + "\n")
                pass
            pass
        except:
            print("ERROR during HTML Insepction")
            pass



        #Check for Codeboxes purely with text
        try:
            Codeboxes = soup.body.find_all("code", {"class": lambda c: c and 'notranslate' in c})
            for code in Codeboxes:
                code_text = code.get_text()
                if(code_text.find("[ERROR]")!=-1):
                    print("Found Debug Log [ERROR] Similarity: Skipping")
                    continue
                if(re.search("[v]\d*[.]\d*[.]\d*",code_text)!=None or re.search("^\d*[.]\d*[.]\d*$",code_text)!=None):
                    print("Found Version Numbering Pattern: Skipping")
                    continue
                if(code_text.find("[INFO]")!=-1):
                    print("Found Debug Log [INFO] Similarity: Skipping")
                    continue
                if(code_text.find("Vulnerabilities found for image")!=-1):
                    print("Found Debug Log (StartText) Similarity: Skipping")
                    continue
                if(len(re.findall("\d\d\d\d[/]\d\d[/]\d\d",code_text))>5):  #find  date patterns
                    print("Found Date Pattern: Skipping")
                    continue
                if(len(re.findall("\d\d[:]\d\d[:]\d\d",code_text))>5):    #find timestamp patterns
                    print("Found Timestamp Pattern: Skipping")
                    continue
                if(code_text.find("<suppress>")!=-1 and code_text.find("</suppress>")!=-1):  #find the supress statements meant to make the CVE not appear anymore in CVE scans
                    CVE_FILE.write("CASE-3" + "\n")  #CASE-3 Supress Statements, which might indicate it to be harmless
                    continue
                if(len(re.findall("(at) (?:\w*[.])*[<]*\w*[>]*\s*([(]\w*[.]\w*[:]\d*[)])",code_text))>0):
                    print("Found Java Exception Log: Skipping") 
                    continue
                if(re.search("(CVE-)\d*[-]\d*",code_text)!=None):
                    print("Found CVE Report: Skipping")
                    continue
                if(re.search("(\w*[.])+(\w*[:])+(\d+[.])+\d+",code_text)!=None or re.search("(\w*[.])+(\w*[:])+(\w*[-]\w*)*(\w*[:])+(\d+[.])+\d+",code_text)!=None):
                    print("Found Package Naming + Version: Skipping")
                    continue
                if(code_text==";" or code_text==","or code_text=="\""or code_text=="'"or code_text=="-"):
                    print("Found random singular character: Skipping")
                    continue
                if(re.search("(-){2,}(\s){4,}",code_text)!=None):
                    print("Found Table Pattern: Skipping")
                    continue
                if(code_text.find("Apache Maven")!=-1 and code_text.find("Maven home")!=-1 and code_text.find("Java version")!=-1):
                    print("Found Maven Information Pattern: Skipping")
                    continue
                if(code_text.find("[installed]")!=-1 
                   or code_text.find("INFO: Skipping")!=-1 
                   or code_text.find("[WARN ]")!=-1 
                   or code_text.find("[notice]")!=-1
                   or code_text.find("DEBUG -")!=-1
                   or code_text.find("[artifact:mvn]")!=-1
                   or code_text.find("================")!=-1):
                    print("Found Table Pattern: Skipping")
                    continue
                if(code_text.find("Version:")!=-1 and code_text.find("BuildDate:")!=-1 and code_text.find("GitCommit:")!=-1):
                    print("Found Commit Information Pattern: Skipping")
                    continue
                if(re.search("(#) ((.){2,}\s)",code_text)!=None):
                    print("Found Terms of Service Pattern: Skipping")
                    continue




                
                CVE_FILE.write("CASE-2" + "\n")
                CVE_FILE.write(code.get_text() + "\n")
                pass
            pass
        except:
            print("ERROR during HTML Insepction")
            pass




        #Check for Class paths that are just text


        pass
    except:
        CVE_FILE.write("ERROR CALLING WEBSITE" + "\n")
        print("ERROR calling of website")
        break

        pass



    pass
CVE_FILE.close()



