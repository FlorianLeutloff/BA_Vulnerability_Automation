import importExtraction
import searchCode
import os
import time
from difflib import SequenceMatcher



def condenseCode(path):
    path = path.replace("\n","")
    file = open(path,"r",encoding="utf8")
    code_string = ""
    for line in file.readlines():
        line = line.replace("\n","")
        line = line.replace("  ", " ")
        line = line.replace("   ", " ")
        line = line.replace("\t","")
        line = line.replace("\v", "")
        line = line.replace("\f", "")
        line = line.replace("\r", "")
        while '  ' in line:
            line = line.replace("  ", " ")
        code_string = code_string + line
        pass
    file.close()
    return code_string

#print(condenseCode("C:\\Users\\flori\\Documents\\AbschlussarbeitProjekt\\Code_Search\\unpacked\\spring-tx-6.0.11\\org\\springframework\\transaction\\TransactionException.java"))

def searchCondCode(search_string, path):
    cond_code = condenseCode(path)
    if(cond_code.find(search_string)!=-1):
        file = open("Search_Result.txt","w")
        file.write(path + "\n")
        file.close()

    pass


def SearchPart(counter, search_file, target_file):
    for index in range(len(search_file)):
        if getSimilarityRatio(target=target_file[counter + index], search= search_file[index]) < 0.8 :
            print(target_file[counter + index])
            print(search_file[index])
            print(str(getSimilarityRatio(target=target_file[counter + index], search= search_file[index])))
            return False
        pass
    pass
    return True

#https://stackoverflow.com/questions/17388213/find-the-similarity-metric-between-two-strings
def getSimilarityRatio(target, search):
    return SequenceMatcher(None, target, search).ratio()
    pass


#new version of search aimed at not condensing things,
#but searching and comparing line by line
def improvedSearch(search_path, target_path):
    search_path = search_path.replace("\n","")
    target_path = target_path.replace("\n","")
    search_file = open(search_path,"r")
    target_file = open(target_path,"r")
    counter = 0
    search_file_list = search_file.readlines()
    target_file_list = target_file.readlines()
    for target_line in target_file_list:
        if(target_path=="unpacked\\spring-security-core-6.1.3\\org\\springframework\\security\\core\\context\\SecurityContextHolder.java"):
            print("test")
        #print(str(getSimilarityRatio(target=target_line, search= search_file_list[0])))
        if getSimilarityRatio(target=target_line, search= search_file_list[0]) > 0.9 :
            result = SearchPart(counter=counter, search_file=search_file_list,target_file=target_file_list)
            if(result):
                file = open("Search_Result","a")
                file.write(target_path + "  | " + str(counter) + "\n")
                file.close()
                continue
            pass
        pass
        counter = counter + 1
    search_file.close()
    target_file.close()
    pass



def noteSearched(file_path):
    file = open("AlreadySearched.txt","a")
    file.write(file_path + "\n")
    file.close()

    pass

def wasSearched(file_path):
    file = open("AlreadySearched.txt","r")
    for line in file.readlines():
        line = line.replace("\n","")
        if(line == file_path):
            file.close()
            return True
        pass
    file.close()
    return False

def locateAndSearch(base_path, import_part, search_string):
    import_location = searchCode.loopUnpacked(base_path=base_path,package_directory=os.listdir(base_path),import_string=import_part, counter=0)
    if(wasSearched(import_location)):
        return []
    import_list = importExtraction.getImportStatements(file_path=import_location, exclude_list=["java.","javax.","kotlin.","org.xml.sax."])
    import_list = import_list + importExtraction.ClassReferenceExtraction(file_path=import_location)
    print(import_location)
    print(import_list)
    try:
        #searchCondCode(search_string=search_string,path=import_location)
        improvedSearch(search_path=search_string, target_path=import_location)
    except:
        print("ERROR")
    if(import_location=="unpacked\\spring-security-core-6.1.3\\org\\springframework\\security\\core\\context\\SecurityContextHolder.java"):
        print("test")
    if(import_location!=None):
        noteSearched(import_location)
        pass
    return import_list


def placeholder(base_path, import_part, search_string):
    import_list = locateAndSearch(base_path=base_path, import_part=import_part, search_string=search_string)
    for import_part in import_list:
        placeholder(base_path=base_path,import_part=import_part,search_string=search_string)

        pass


    pass
"""
def placeholder(base_path, import_part, search_string):

    import_location = searchCode.loopUnpacked(base_path=base_path,package_directory=os.listdir(base_path),import_string=import_part, counter=0)
    
    import_list = importExtraction.getImportStatements(file_path=import_location, exclude_list=["java.","javax."])
    import_list = import_list + importExtraction.ClassReferenceExtraction(file_path=import_location)
    print("\n")
    print(base_path)
    print(import_part)
    print(import_location)
    print(import_list)
    searchCondCode(search_string=search_string,path=import_location)
    
    for import_part in import_list:
        placeholder(base_path=base_path,import_part=import_part,search_string=search_string)

        pass


    pass
"""
#project is a list of all Project File Paths
#search_string is the already condensed string that is meant to be searched
#base_path is the path to the unpacked stuff and so on
def findCode(project,search_string,base_path, exclude_list):

    for file_path in project:
        #searchCondCode(search_string=search_string,path=file_path)
        improvedSearch(search_path=search_string, target_path=file_path)
        import_list = importExtraction.getImportStatements(file_path=file_path,exclude_list=exclude_list)
        for import_part in import_list:
            placeholder(base_path=base_path, import_part=import_part,search_string=search_string)
            pass
        pass
    pass


project = open("test_liste.txt","r").readlines()

#search_string =  condenseCode("text.txt")
search_string = "text.txt"
exclude_list = ["com.zufar.onlinestore","java.","javax.","kotlin.","org.xml.sax."]
findCode(project=project,search_string=search_string,exclude_list=exclude_list, base_path="unpacked")