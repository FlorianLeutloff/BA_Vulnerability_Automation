import pandas as pd
import copy
import re 
def getCountForLinkList(Link_List,dataframe,Main_dictionary, already_read_links):
    Link_dictionary = {}
    for link in Link_List:
        if(link in already_read_links):
            #print("Skipping")
            continue
        count_dictionary = {'CASE-1':0,
                        'CASE-2':0,
                        'CASE-3':0}
        #print(link)
        #case_list = dataframe.loc[link]
        case_list = dataframe[link]
        #previously for entry in case_list.loc['CASE-1']:
        for entry in case_list['CASE-1']:
            if(entry==""):
                #print("BREAKING")
                continue
            count_dictionary['CASE-1'] = count_dictionary['CASE-1'] + 1
        for entry in case_list['CASE-2']:
            if(entry==""):
                #print("BREAKING")
                continue
            count_dictionary['CASE-2'] = count_dictionary['CASE-2'] + 1
            if(str(entry).find('{')!=-1 and str(entry).find('}')!=-1 or re.search("\w+\.\w+\(\)",str(entry))!=None or (str(entry).find('{')!=-1 and str(entry).find('class')!=-1) or ((str(entry).find('public')!=-1 or str(entry).find('private')!=-1 or str(entry).find('static')!=-1) and len(str(entry)) > 10)):
                Main_dictionary['Count_CASE-2_LONG_CODE'] = Main_dictionary['Count_CASE-2_LONG_CODE'] + 1
            else:
                Main_dictionary['Count_CASE-2_SHORT_CODE'] = Main_dictionary['Count_CASE-2_SHORT_CODE'] + 1

        for entry in case_list['CASE-3']:
            if(entry==""):
                #print("BREAKING")
                continue
            count_dictionary['CASE-3'] = count_dictionary['CASE-3'] + 1        

            pass

            pass
        Link_dictionary[link] = copy.deepcopy(count_dictionary)
        pass
    return copy.deepcopy(Link_dictionary), copy.deepcopy(Main_dictionary)
    pass

def questionDictionary(Link_dictionary, Main_dictionary):
    for count_dictionary in Link_dictionary.values():
        Override = True
        #print(count_dictionary['CASE-1'])
        if(count_dictionary['CASE-1'] > 0):
            Main_dictionary['Count_LINK_WITH_CASE-1'] = Main_dictionary['Count_LINK_WITH_CASE-1'] + 1
            Main_dictionary['Count_EXTRACTED_CASE-1'] = Main_dictionary['Count_EXTRACTED_CASE-1'] + count_dictionary['CASE-1']
            if(Override):
                Main_dictionary['Count_LINK_WITH_CONTENT'] = Main_dictionary['Count_LINK_WITH_CONTENT'] + 1
                Override = False
                pass
            pass
        if(count_dictionary['CASE-2'] > 0):
            Main_dictionary['Count_LINK_WITH_CASE-2'] = Main_dictionary['Count_LINK_WITH_CASE-2'] + 1
            Main_dictionary['Count_EXTRACTED_CASE-2'] = Main_dictionary['Count_EXTRACTED_CASE-2'] + count_dictionary['CASE-2']
            if(Override):
                Main_dictionary['Count_LINK_WITH_CONTENT'] = Main_dictionary['Count_LINK_WITH_CONTENT'] + 1
                Override = False
                pass            
            pass        
        if(count_dictionary['CASE-3'] > 0):
            Main_dictionary['Count_LINK_WITH_CASE-3'] = Main_dictionary['Count_LINK_WITH_CASE-3'] + 1
            Main_dictionary['Count_EXTRACTED_CASE-3'] = Main_dictionary['Count_EXTRACTED_CASE-3'] + count_dictionary['CASE-3']
            if(Override):
                Main_dictionary['Count_LINK_WITH_CONTENT'] = Main_dictionary['Count_LINK_WITH_CONTENT'] + 1
                Override = False
                pass            
            pass
        if(Override):
            Main_dictionary['Count_LINK_WITHOUT_CONTENT'] = Main_dictionary['Count_LINK_WITHOUT_CONTENT'] + 1
            pass
        pass
    return copy.deepcopy(Main_dictionary)

    pass

def countCVECASE(Link_dictionary, Main_dictionary, link_list):
    case1Override = True
    case2Override = True
    case3Override = True

    for link in link_list:
        count_dictionary = Link_dictionary[link]
        if(count_dictionary['CASE-1'] > 0 and case1Override):
            Main_dictionary['Count_CVES_WITH_CASE-1'] = Main_dictionary['Count_CVES_WITH_CASE-1'] + 1
            case1Override = False
            pass
        if(count_dictionary['CASE-2'] > 0 and case2Override):
            Main_dictionary['Count_CVES_WITH_CASE-2'] = Main_dictionary['Count_CVES_WITH_CASE-2'] + 1
            case2Override = False
            pass
        if(count_dictionary['CASE-3'] > 0 and case3Override):
            Main_dictionary['Count_CVES_WITH_CASE-3'] = Main_dictionary['Count_CVES_WITH_CASE-3'] + 1
            case3Override = False
            pass
        pass        
    pass
    if(case1Override==False or case2Override==False or case3Override==False):
        Main_dictionary['Count_CVES_WITH_CONTENT'] = Main_dictionary['Count_CVES_WITH_CONTENT'] + 1
        pass
    if(case1Override==True and case2Override==True and case3Override==True):
        Main_dictionary['Count_CVES_WITHOUT_CONTENT'] = Main_dictionary['Count_CVES_WITHOUT_CONTENT'] + 1
        pass    
    return copy.deepcopy(Main_dictionary)


    pass



CVE_LINK_DF = pd.read_excel(io="CVE_LINK_DF_UNREVISED.xlsx", header=0)
LINK_CASE_DF = pd.read_excel(io="LINK_CASE_DF_UNREVISED.xlsx", header=[0,1],index_col=0)
CVE_LINK_DF.fillna("",inplace=True)
LINK_CASE_DF.fillna("",inplace=True)
print(CVE_LINK_DF.info)
print(LINK_CASE_DF.info)

print(LINK_CASE_DF.at[0,("https://github.com/dom4j/dom4j/issues/171",'CASE-2')])
print("TEST12")
print(LINK_CASE_DF["https://github.com/dom4j/dom4j/issues/171"])


dictionary = {'Count_CVES_WITH_LINK':0,
              'Count_CVES_WITHOUT_LINK':0,
              'Count_CVES_WITH_CONTENT':0,
              'Count_CVES_WITHOUT_CONTENT':0,
              'Count_CVES_WITH_CASE-1':0,    #if a CVE has a link that got something with Case-1, we add one, and move on from that CVE for case 1
              'Count_CVES_WITH_CASE-2':0,
              'Count_CVES_WITH_CASE-3':0,
              'Count_EXTRACTED_CASE-1':0,    #We count the total amount of Case-1 Elements extracted, make statements like, for everylink there exist around 13,7 Extracted Points
              'Count_EXTRACTED_CASE-2':0,
              'Count_EXTRACTED_CASE-3':0,
              'Count_LINK_WITH_CONTENT':0,      #Count how many Links have content
              'Count_LINK_WITHOUT_CONTENT':0,   #Count how many Links do not have any content
              'Count_LINK_WITH_CASE-1':0,   #Count how many Links have atleast one Case-1
              'Count_LINK_WITH_CASE-2':0,
              'Count_LINK_WITH_CASE-3':0,
              'Count_CASE-2_LONG_CODE':0,
              'Count_CASE-2_SHORT_CODE':0}




already_read_links = []
Full_dictionary = {}
for CVE in CVE_LINK_DF.columns:

    Override = True
    Link_List = []
    for link in CVE_LINK_DF[CVE]:
        if(link!="" and Override):
            dictionary['Count_CVES_WITH_LINK'] = dictionary['Count_CVES_WITH_LINK'] + 1
            Override = False
        if(link == "" and Override):
            dictionary['Count_CVES_WITHOUT_LINK'] = dictionary['Count_CVES_WITHOUT_LINK'] + 1
            Override = False
        if(link != ""):
            Link_List.append(link)
        elif(len(Link_List)>0):
            int_cnt_SLN, dictionary = getCountForLinkList(Link_List=Link_List,dataframe=LINK_CASE_DF,Main_dictionary=dictionary, already_read_links=already_read_links)
            Full_dictionary = {**Full_dictionary, **int_cnt_SLN}
            dictionary = questionDictionary(Link_dictionary=int_cnt_SLN,Main_dictionary=copy.deepcopy(dictionary))
            dictionary = countCVECASE(Link_dictionary=Full_dictionary, Main_dictionary=copy.deepcopy(dictionary),link_list=Link_List)
            for int_link in Link_List:
                already_read_links.append(int_link)
                pass          
            Link_List = []
            break
            pass
            pass
        pass

    pass

print(dictionary)