import re
import pandas as pd
from IPython.display import display
def iterateThroughCase3(dataframe,main_link,):
    for LC_Index in range(100):
        if(dataframe.at[LC_Index,(main_link,'CASE-1')]=="" and dataframe.at[LC_Index,(main_link,'CASE-2')]=="" and dataframe.at[LC_Index,(main_link,'CASE-3')]==""):
            dataframe.at[LC_Index,(main_link,'CASE-3')] = "X"#marks the fact that there exists supression suggestions for this
            break
        pass
    return dataframe
    pass

def iterateThrough(main_link,dataframe,line_list, counter, internal_counter, case):
    internal_internal_counter = internal_counter + 1
    Result_String = ""
    while(line_list[counter+internal_internal_counter].find("CASE-1")==-1 and line_list[counter+internal_internal_counter].find("CASE-2")==-1 and line_list[counter+internal_internal_counter].find("CASE-3")==-1 and line_list[counter+internal_internal_counter].find("MAINLINK=")==-1 and line_list[counter+internal_internal_counter].find("##############")==-1):
        internal_line = line_list[counter+internal_internal_counter]
        Result_String = Result_String + internal_line
        internal_internal_counter = internal_internal_counter + 1
    pass
    for LC_Index in range(100):
        if(dataframe.at[LC_Index,(main_link,'CASE-1')]=="" and dataframe.at[LC_Index,(main_link,'CASE-2')]=="" and dataframe.at[LC_Index,(main_link,'CASE-3')]==""):
            dataframe.at[LC_Index,(main_link,case)] = Result_String
            break
        pass
    return dataframe
    pass

#Source https://stackoverflow.com/questions/51021468/can-sub-columns-be-created-in-a-pandas-data-frame
def add_top_column(df, top_col, inplace=False):
    if not inplace:
        df = df.copy()
    
    df.columns = pd.MultiIndex.from_product([[top_col], df.columns])
    return df

CVE_File = open("CVE_SOURCES_INFORMATION.txt","r")
line_list = CVE_File.readlines()


CVE_LINK_DF = pd.DataFrame()
LINK_CASE_DF = pd.DataFrame()

blank_link_array = [""] * 100
counter = 0
for line in line_list:
    line=line.replace("\n","")
    if(re.search("^(CVE){1}(-)\d{4}(-)\d*$", line)!=None):
        CVE = line
        CVE_LINK_DF = CVE_LINK_DF.assign(CVE=blank_link_array)
        CVE_LINK_DF.rename(columns={"CVE":CVE},inplace=True)
        print(CVE_LINK_DF.info)
        internal_counter = 1
        OverWrite = True
        main_link = ""
        while(re.search("^(CVE){1}(-)\d{4}(-)\d*$", line)==None or OverWrite):
            OverWrite = False
            line=line_list[counter+internal_counter]
            if(line.find("MAINLINK=")!=-1):
                print("FOUND MAINLINK")
                for index in range(100):
                    if(CVE_LINK_DF.at[index,CVE]!=""):
                        continue
                    line = line.replace("MAINLINK=","")
                    line = line.replace("\n","")
                    main_link = line
                    print("INTERNAL MAINLINK = "+main_link)
                    CVE_LINK_DF.at[index,CVE] = main_link #asigns MAINLINK to the chain
                    LC_COLUMN = pd.DataFrame([["","",""]]*100, columns=['CASE-1', 'CASE-2', 'CASE-3'])
                    LC_COLUMN = add_top_column(LC_COLUMN,main_link)
                    save_DF = LINK_CASE_DF.copy(deep=True)
                    LINK_CASE_DF = pd.concat([LINK_CASE_DF,LC_COLUMN],axis=1)
                    if(LINK_CASE_DF.columns.has_duplicates):
                        LINK_CASE_DF = save_DF.copy(deep=True)
                        print("DUBLIKATE DETECTED: ROLLING BACK")
                    break
                    pass
                pass
            print("COUNTER = "+str(counter))
            print("MAINLINK = "+main_link)
            print("CVE = " + CVE)
            print("LINE = "+line)
            if(line.find("CASE-1")!=-1):
                LINK_CASE_DF = iterateThrough(main_link=main_link,dataframe=LINK_CASE_DF,line_list=line_list,counter=counter,internal_counter=internal_counter,case='CASE-1')
                """"
                internal_internal_counter = internal_counter + 1
                Result_String = ""
                while(line_list[counter+internal_internal_counter].find("CASE-1")==-1 and line_list[counter+internal_internal_counter].find("CASE-2")==-1 and line_list[counter+internal_internal_counter].find("CASE-3")==-1 and line_list[counter+internal_internal_counter].find("MAINLINK=")==-1 and line_list[counter+internal_internal_counter].find("##############")==-1):
                    internal_line = line_list[counter+internal_internal_counter]
                    Result_String = Result_String + internal_line
                    internal_internal_counter = internal_internal_counter + 1
                    pass
                for LC_Index in range(100):
                    if(LINK_CASE_DF.at[LC_Index,(main_link,'CASE-1')]==""):
                        LINK_CASE_DF.at[LC_Index,(main_link,'CASE-1')] = Result_String
                        break
                    pass
                """
                pass
            if(line.find("CASE-2")!=-1):
                LINK_CASE_DF = iterateThrough(main_link=main_link,dataframe=LINK_CASE_DF,line_list=line_list,counter=counter,internal_counter=internal_counter,case='CASE-2')              
                pass
            if(line.find("CASE-3")!=-1):
                LINK_CASE_DF = iterateThroughCase3(main_link=main_link,dataframe=LINK_CASE_DF)              
                pass
            if(line.find("##############")!=-1):
                break
            internal_counter = internal_counter + 1
            pass
    
    counter = counter + 1
    if(line.find("##############")!=-1):
        continue
        pass
#LINK_CASE_DF.to_excel(excel_writer="EXCEL.xlsx")
writer1 = pd.ExcelWriter('LINK_CASE_DF_UNREVISED_V2.xlsx', engine='xlsxwriter')
writer2 = pd.ExcelWriter('CVE_LINK_DF_UNREVISED_V2.xlsx', engine='xlsxwriter')
LINK_CASE_DF.to_excel(excel_writer="LINK_CASE_DF_UNREVISED_V2.xlsx")
CVE_LINK_DF.to_excel(excel_writer="CVE_LINK_DF_UNREVISED_V2.xlsx")
#show(CVE_LINK_DF)