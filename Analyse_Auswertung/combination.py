import re
import pandas as pd
from IPython.display import display
import copy
def iterateThroughCase3(dataframe,main_link,):
    for LC_Index in range(100):
        if(dataframe.at[LC_Index,(main_link,'CASE-1')]=="" and dataframe.at[LC_Index,(main_link,'CASE-2')]=="" and dataframe.at[LC_Index,(main_link,'CASE-3')]==""):
            dataframe.at[LC_Index,(main_link,'CASE-3')] = "X"#marks the fact that there exists supression suggestions for this
            break
        pass
    return dataframe
    pass

def iterateThrough(main_link,dataframe,line_list, counter, internal_counter, case):
    internal_internal_counter = internal_counter + 1
    Result_String = ""
    while(line_list[counter+internal_internal_counter].find("CASE-1")==-1 and line_list[counter+internal_internal_counter].find("CASE-2")==-1 and line_list[counter+internal_internal_counter].find("CASE-3")==-1 and line_list[counter+internal_internal_counter].find("MAINLINK=")==-1 and line_list[counter+internal_internal_counter].find("##############")==-1):
        internal_line = line_list[counter+internal_internal_counter]
        Result_String = Result_String + internal_line
        Result_String = Result_String.replace("\n","")
        Result_String = Result_String.replace("\t","")
        internal_internal_counter = internal_internal_counter + 1
    pass
    for LC_Index in range(100):
        if(dataframe.at[LC_Index,(main_link,'CASE-1')]=="" and dataframe.at[LC_Index,(main_link,'CASE-2')]=="" and dataframe.at[LC_Index,(main_link,'CASE-3')]==""):
            dataframe.at[LC_Index,(main_link,case)] = Result_String
            break
        pass
    return dataframe
    pass

#Source https://stackoverflow.com/questions/51021468/can-sub-columns-be-created-in-a-pandas-data-frame
def add_top_column(df, top_col, inplace=False):
    if not inplace:
        df = df.copy()
    
    df.columns = pd.MultiIndex.from_product([[top_col], df.columns])
    return df

def getCountForLinkList(Link_List,dataframe,Main_dictionary):
    Link_dictionary = {}
    parsed = open("test.txt","r")
    already_read_links = parsed.readlines()
    parsed.close()
    for link in Link_List:
        Skip = False
        for int_link in already_read_links:
            int_link = int_link.replace("\n","")
            print("INTLINK = "+int_link)
            print("LINK = "+link)
            if(link == int_link):
                print("Skipping")
                Skip = True
                break
        if(Skip):
            continue
        count_dictionary = {'CASE-1':0,
                        'CASE-2':0,
                        'CASE-3':0}
        print(link)
        #case_list = dataframe.loc[link]
        case_list = dataframe[link]
        #previously for entry in case_list.loc['CASE-1']:
        for entry in case_list['CASE-1']:
            if(entry==""):
                break
            count_dictionary['CASE-1'] = count_dictionary['CASE-1'] + 1
        for entry in case_list['CASE-2']:
            if(entry==""):
                break
            count_dictionary['CASE-2'] = count_dictionary['CASE-2'] + 1
            if(str(entry).find('{')!=-1 and str(entry).find('}')!=-1 or re.search("\w+\.\w+\(\)",str(entry))!=None or (str(entry).find('{')!=-1 and str(entry).find('class')!=-1) or ((str(entry).find('public')!=-1 or str(entry).find('private')!=-1 or str(entry).find('static')!=-1) and len(str(entry)) > 10)):
                Main_dictionary['Count_CASE-2_LONG_CODE'] = Main_dictionary['Count_CASE-2_LONG_CODE'] + 1
            else:
                Main_dictionary['Count_CASE-2_SHORT_CODE'] = Main_dictionary['Count_CASE-2_SHORT_CODE'] + 1

        for entry in case_list['CASE-3']:
            if(entry==""):
                break
            count_dictionary['CASE-3'] = count_dictionary['CASE-3'] + 1        

            pass

            pass
        Link_dictionary[link] = copy.deepcopy(count_dictionary)
        pass
    return copy.deepcopy(Link_dictionary), copy.deepcopy(Main_dictionary)
    pass

def questionDictionary(Link_dictionary, Main_dictionary):
    for count_dictionary in Link_dictionary.values():
        Override = True
        print(count_dictionary['CASE-1'])
        if(count_dictionary['CASE-1'] > 0):
            Main_dictionary['Count_LINK_WITH_CASE-1'] = Main_dictionary['Count_LINK_WITH_CASE-1'] + 1
            Main_dictionary['Count_EXTRACTED_CASE-1'] = Main_dictionary['Count_EXTRACTED_CASE-1'] + count_dictionary['CASE-1']
            if(Override):
                Main_dictionary['Count_LINK_WITH_CONTENT'] = Main_dictionary['Count_LINK_WITH_CONTENT'] + 1
                Override = False
                pass
            pass
        if(count_dictionary['CASE-2'] > 0):
            Main_dictionary['Count_LINK_WITH_CASE-2'] = Main_dictionary['Count_LINK_WITH_CASE-2'] + 1
            Main_dictionary['Count_EXTRACTED_CASE-2'] = Main_dictionary['Count_EXTRACTED_CASE-2'] + count_dictionary['CASE-2']
            if(Override):
                Main_dictionary['Count_LINK_WITH_CONTENT'] = Main_dictionary['Count_LINK_WITH_CONTENT'] + 1
                Override = False
                pass            
            pass        
        if(count_dictionary['CASE-3'] > 0):
            Main_dictionary['Count_LINK_WITH_CASE-3'] = Main_dictionary['Count_LINK_WITH_CASE-3'] + 1
            Main_dictionary['Count_EXTRACTED_CASE-3'] = Main_dictionary['Count_EXTRACTED_CASE-3'] + count_dictionary['CASE-3']
            if(Override):
                Main_dictionary['Count_LINK_WITH_CONTENT'] = Main_dictionary['Count_LINK_WITH_CONTENT'] + 1
                Override = False
                pass            
            pass
        if(Override):
            Main_dictionary['Count_LINK_WITHOUT_CONTENT'] = Main_dictionary['Count_LINK_WITHOUT_CONTENT'] + 1
            pass
        pass
    return copy.deepcopy(Main_dictionary)

    pass

def countCVECASE(Link_dictionary, Main_dictionary):
    case1Override = True
    case2Override = True
    case3Override = True
    for count_dictionary in Link_dictionary.values():
        if(count_dictionary['CASE-1'] > 0 and case1Override):
            Main_dictionary['Count_CVES_WITH_CASE-1'] = Main_dictionary['Count_CVES_WITH_CASE-1'] + 1
            case1Override = False
            pass
        if(count_dictionary['CASE-2'] > 0 and case2Override):
            Main_dictionary['Count_CVES_WITH_CASE-2'] = Main_dictionary['Count_CVES_WITH_CASE-2'] + 1
            case2Override = False
            pass
        if(count_dictionary['CASE-3'] > 0 and case3Override):
            Main_dictionary['Count_CVES_WITH_CASE-3'] = Main_dictionary['Count_CVES_WITH_CASE-3'] + 1
            case3Override = False
            pass
        pass
    if(case1Override==False or case2Override==False or case3Override==False):
        Main_dictionary['Count_CVES_WITH_CONTENT'] = Main_dictionary['Count_CVES_WITH_CONTENT'] + 1
        pass
    if(case1Override==True and case2Override==True and case3Override==True):
        Main_dictionary['Count_CVES_WITHOUT_CONTENT'] = Main_dictionary['Count_CVES_WITHOUT_CONTENT'] + 1
        pass    
    return copy.deepcopy(Main_dictionary)


    pass


CVE_File = open("CVE_SOURCES_INFORMATION.txt","r")
line_list = CVE_File.readlines()


CVE_LINK_DF = pd.DataFrame()
LINK_CASE_DF = pd.DataFrame()

blank_link_array = [""] * 100
counter = 0
for line in line_list:
    line=line.replace("\n","")
    if(re.search("^(CVE){1}(-)\d{4}(-)\d*$", line)!=None):
        CVE = line
        CVE_LINK_DF = CVE_LINK_DF.assign(CVE=blank_link_array)
        CVE_LINK_DF.rename(columns={"CVE":CVE},inplace=True)
        print(CVE_LINK_DF.info)
        internal_counter = 1
        OverWrite = True
        main_link = ""
        while(re.search("^(CVE){1}(-)\d{4}(-)\d*$", line)==None or OverWrite):
            OverWrite = False
            line=line_list[counter+internal_counter]
            if(line.find("MAINLINK=")!=-1):
                print("FOUND MAINLINK")
                for index in range(100):
                    if(CVE_LINK_DF.at[index,CVE]!=""):
                        continue
                    line = line.replace("MAINLINK=","")
                    line = line.replace("\n","")
                    main_link = line
                    print("INTERNAL MAINLINK = "+main_link)
                    CVE_LINK_DF.at[index,CVE] = main_link #asigns MAINLINK to the chain
                    LC_COLUMN = pd.DataFrame([["","",""]]*100, columns=['CASE-1', 'CASE-2', 'CASE-3'])
                    LC_COLUMN = add_top_column(LC_COLUMN,main_link)
                    save_DF = LINK_CASE_DF.copy(deep=True)
                    LINK_CASE_DF = pd.concat([LINK_CASE_DF,LC_COLUMN],axis=1)
                    if(LINK_CASE_DF.columns.has_duplicates):
                        LINK_CASE_DF = save_DF.copy(deep=True)
                        print("DUBLIKATE DETECTED: ROLLING BACK")
                    break
                    pass
                pass
            print("COUNTER = "+str(counter))
            print("MAINLINK = "+main_link)
            print("CVE = " + CVE)
            print("LINE = "+line)
            if(line.find("CASE-1")!=-1):
                LINK_CASE_DF = iterateThrough(main_link=main_link,dataframe=LINK_CASE_DF,line_list=line_list,counter=counter,internal_counter=internal_counter,case='CASE-1')
                """"
                internal_internal_counter = internal_counter + 1
                Result_String = ""
                while(line_list[counter+internal_internal_counter].find("CASE-1")==-1 and line_list[counter+internal_internal_counter].find("CASE-2")==-1 and line_list[counter+internal_internal_counter].find("CASE-3")==-1 and line_list[counter+internal_internal_counter].find("MAINLINK=")==-1 and line_list[counter+internal_internal_counter].find("##############")==-1):
                    internal_line = line_list[counter+internal_internal_counter]
                    Result_String = Result_String + internal_line
                    internal_internal_counter = internal_internal_counter + 1
                    pass
                for LC_Index in range(100):
                    if(LINK_CASE_DF.at[LC_Index,(main_link,'CASE-1')]==""):
                        LINK_CASE_DF.at[LC_Index,(main_link,'CASE-1')] = Result_String
                        break
                    pass
                """
                pass
            if(line.find("CASE-2")!=-1):
                LINK_CASE_DF = iterateThrough(main_link=main_link,dataframe=LINK_CASE_DF,line_list=line_list,counter=counter,internal_counter=internal_counter,case='CASE-2')              
                pass
            if(line.find("CASE-3")!=-1):
                LINK_CASE_DF = iterateThroughCase3(main_link=main_link,dataframe=LINK_CASE_DF)              
                pass
            if(line.find("##############")!=-1):
                break
            internal_counter = internal_counter + 1
            pass
    
    counter = counter + 1
    if(line.find("##############")!=-1):
        continue
        pass
#LINK_CASE_DF.to_excel(excel_writer="EXCEL.xlsx")
#writer1 = pd.ExcelWriter('LINK_CASE_DF_UNREVISED_V2.xlsx', engine='xlsxwriter')
#writer2 = pd.ExcelWriter('CVE_LINK_DF_UNREVISED_V2.xlsx', engine='xlsxwriter')
#LINK_CASE_DF.to_excel(excel_writer="LINK_CASE_DF_UNREVISED_V2.xlsx")
#CVE_LINK_DF.to_excel(excel_writer="CVE_LINK_DF_UNREVISED_V2.xlsx")
#show(CVE_LINK_DF)

print(CVE_LINK_DF.info)
print(LINK_CASE_DF.info)

print(LINK_CASE_DF.at[0,("https://github.com/dom4j/dom4j/issues/171",'CASE-2')])
print("TEST12")
print(LINK_CASE_DF["https://github.com/dom4j/dom4j/issues/171"])


dictionary = {'Count_CVES_WITH_LINK':0,
              'Count_CVES_WITHOUT_LINK':0,
              'Count_CVES_WITH_CONTENT':0,
              'Count_CVES_WITHOUT_CONTENT':0,
              'Count_CVES_WITH_CASE-1':0,    #if a CVE has a link that got something with Case-1, we add one, and move on from that CVE for case 1
              'Count_CVES_WITH_CASE-2':0,
              'Count_CVES_WITH_CASE-3':0,
              'Count_EXTRACTED_CASE-1':0,    #We count the total amount of Case-1 Elements extracted, make statements like, for everylink there exist around 13,7 Extracted Points
              'Count_EXTRACTED_CASE-2':0,
              'Count_EXTRACTED_CASE-3':0,
              'Count_LINK_WITH_CONTENT':0,      #Count how many Links have content
              'Count_LINK_WITHOUT_CONTENT':0,   #Count how many Links do not have any content
              'Count_LINK_WITH_CASE-1':0,   #Count how many Links have atleast one Case-1
              'Count_LINK_WITH_CASE-2':0,
              'Count_LINK_WITH_CASE-3':0,
              'Count_CASE-2_LONG_CODE':0,
              'Count_CASE-2_SHORT_CODE':0}





for CVE in CVE_LINK_DF.columns:

    Override = True
    Link_List = []
    for link in CVE_LINK_DF[CVE]:
        if(link!="" and Override):
            dictionary['Count_CVES_WITH_LINK'] = dictionary['Count_CVES_WITH_LINK'] + 1
            Override = False
        if(link == "" and Override):
            dictionary['Count_CVES_WITHOUT_LINK'] = dictionary['Count_CVES_WITHOUT_LINK'] + 1
            Override = False
        if(link != ""):
            Link_List.append(link)
        elif(len(Link_List)>0):
            int_cnt_SLN, dictionary = getCountForLinkList(Link_List=Link_List,dataframe=LINK_CASE_DF,Main_dictionary=dictionary)
            dictionary = questionDictionary(Link_dictionary=int_cnt_SLN,Main_dictionary=copy.deepcopy(dictionary))
            dictionary = countCVECASE(Link_dictionary=int_cnt_SLN, Main_dictionary=copy.deepcopy(dictionary))
            Already_Parsed_Links = open("test.txt","a")
            for int_link in Link_List:
                Already_Parsed_Links.write(int_link + "\n")
                pass
            Already_Parsed_Links.close()
            Link_List = []
            
            break
            pass
            pass
        pass

    pass

print(dictionary)